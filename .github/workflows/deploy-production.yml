name: Deploy Production

on:
  push:
    branches:
      - main

permissions:
  contents: write

env:
  REGISTRY: registry.rsft.co
  BACKEND_IMAGE: bluerelief/backend
  FRONTEND_IMAGE: bluerelief/frontend
  EMAIL_SERVICE_IMAGE: bluerelief/email-service

jobs:
  version:
    runs-on: self-hosted
    outputs:
      version: ${{ steps.version.outputs.version }}
      current_version: ${{ steps.version.outputs.current_version }}
      bump_type: ${{ steps.version.outputs.bump_type }}
      commit_sha: ${{ steps.vars.outputs.commit_sha }}
      image_tag: ${{ steps.vars.outputs.image_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Auto-bump version
        id: version
        run: |
          chmod +x scripts/auto-version.sh
          OUTPUT=$(./scripts/auto-version.sh)
          
          CURRENT_VERSION=$(echo "$OUTPUT" | grep "current_version=" | cut -d'=' -f2)
          NEW_VERSION=$(echo "$OUTPUT" | grep "new_version=" | cut -d'=' -f2)
          BUMP_TYPE=$(echo "$OUTPUT" | grep "bump_type=" | cut -d'=' -f2)
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT

      - name: Set up environment
        id: vars
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          COMMIT_SHA=$(git rev-parse --short HEAD)
          IMAGE_TAG="v${VERSION}-${COMMIT_SHA}"
          
          echo "Building production release:"
          echo "  Previous Version: v${{ steps.version.outputs.current_version }}"
          echo "  New Version: v${VERSION}"
          echo "  Bump Type: ${{ steps.version.outputs.bump_type }}"
          echo "  Commit SHA: $COMMIT_SHA"
          echo "  Image Tag: $IMAGE_TAG"
          echo "  Message: $(git log -1 --pretty=%B | head -n 1)"
          echo "  Author: $(git log -1 --pretty=%an)"
          echo "  Date: $(git log -1 --pretty=%ad)"
          echo ""
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

  build:
    needs: version
    runs-on: self-hosted
    strategy:
      matrix:
        service:
          - name: backend
            context: server
            dockerfile: Dockerfile.prod
            image: bluerelief/backend
          - name: frontend
            context: client
            dockerfile: Dockerfile.prod
            image: bluerelief/frontend
          - name: email-service
            context: email-service
            dockerfile: Dockerfile
            image: bluerelief/email-service
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build and push ${{ matrix.service.name }}
        run: |
          cd ${{ matrix.service.context }}
          
          BUILD_ARGS="--build-arg VERSION=${{ needs.version.outputs.version }}"
          
          if [ "${{ matrix.service.name }}" = "backend" ]; then
            BUILD_ARGS="$BUILD_ARGS --build-arg COMMIT_SHA=${{ needs.version.outputs.commit_sha }}"
          elif [ "${{ matrix.service.name }}" = "frontend" ]; then
            BUILD_ARGS="$BUILD_ARGS --build-arg NEXT_PUBLIC_API_URL=https://api.private.bluerelief.app"
            BUILD_ARGS="$BUILD_ARGS --build-arg NEXT_PUBLIC_MAPBOX_TOKEN=${{ secrets.NEXT_PUBLIC_MAPBOX_TOKEN }}"
          fi
          
          docker build \
            -f ${{ matrix.service.dockerfile }} \
            $BUILD_ARGS \
            -t ${{ env.REGISTRY }}/${{ matrix.service.image }}:${{ needs.version.outputs.image_tag }} \
            -t ${{ env.REGISTRY }}/${{ matrix.service.image }}:latest \
            .
          
          docker push ${{ env.REGISTRY }}/${{ matrix.service.image }}:${{ needs.version.outputs.image_tag }}
          docker push ${{ env.REGISTRY }}/${{ matrix.service.image }}:latest

  deploy:
    needs: [version, build]
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Deploy to production
        run: |
          helm upgrade --install bluerelief \
            /home/geeth/Development/k8s/helm/celery-app-chart \
            -f /home/geeth/Development/k8s/helm/celery-app-chart/bluerelief-values.yaml \
            -n bluerelief \
            --create-namespace \
            --set app.image.tag=${{ needs.version.outputs.image_tag }} \
            --set frontend.image.tag=${{ needs.version.outputs.image_tag }} \
            --set emailService.image.tag=${{ needs.version.outputs.image_tag }} \
            --set emailService.ingress.enabled=true \
            --set emailService.ingress.host="email-api.private.bluerelief.app" \
            --wait

      - name: Create Git Tag and Release
        run: |
          VERSION="v${{ needs.version.outputs.version }}"
          
          # Create and push tag
          git tag -a "$VERSION" -m "Release $VERSION" || echo "Tag exists"
          git push origin "$VERSION" || echo "Tag already pushed"
          
          # Get previous tag for release notes
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || git rev-list --max-parents=0 HEAD)
          
          # Get commits between tags
          COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          
          # Categorize commits
          BREAKING=$(echo "$COMMITS" | grep -i "BREAKING CHANGE" || echo "")
          FEATURES=$(echo "$COMMITS" | grep -iE "^- (feat|feature):" || echo "")
          FIXES=$(echo "$COMMITS" | grep -i "^- fix:" || echo "")
          CHORES=$(echo "$COMMITS" | grep -iE "^- (chore|docs|ci):" || echo "")
          
          # Build release notes
          NOTES="## Release ${VERSION}\n\n"
          NOTES="${NOTES}**Type:** ${{ needs.version.outputs.bump_type }} release\n\n"
          
          [ -n "$BREAKING" ] && NOTES="${NOTES}### ğŸ’¥ Breaking Changes\n${BREAKING}\n\n"
          [ -n "$FEATURES" ] && NOTES="${NOTES}### âœ¨ New Features\n${FEATURES}\n\n"
          [ -n "$FIXES" ] && NOTES="${NOTES}### ğŸ› Bug Fixes\n${FIXES}\n\n"
          [ -n "$CHORES" ] && NOTES="${NOTES}### ğŸ—ï¸ Maintenance\n${CHORES}\n\n"
          
          # Save release notes
          echo -e "$NOTES" > release_notes.md
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.version.outputs.version }}
          name: Release v${{ needs.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Production deployment complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Version:       v${{ needs.version.outputs.current_version }} â†’ v${{ needs.version.outputs.version }}"
          echo "Type:          ${{ needs.version.outputs.bump_type }} release"
          echo "Commit:        ${{ needs.version.outputs.commit_sha }}"
          echo "Backend:       https://api.private.bluerelief.app"
          echo "Frontend:      https://platform.private.bluerelief.app"
          echo "Email Service: https://email-api.private.bluerelief.app"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
