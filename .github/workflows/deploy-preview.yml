name: Deploy Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  REGISTRY: registry.rsft.co
  BACKEND_IMAGE: bluerelief/backend
  FRONTEND_IMAGE: bluerelief/frontend
  EMAIL_SERVICE_IMAGE: bluerelief/email-service

jobs:
  setup:
    runs-on: self-hosted
    outputs:
      main_version: ${{ steps.version_prediction.outputs.main_version }}
      new_version: ${{ steps.version_prediction.outputs.new_version }}
      bump_type: ${{ steps.version_prediction.outputs.bump_type }}
      branch_name: ${{ steps.vars.outputs.branch_name }}
      sanitized_branch: ${{ steps.vars.outputs.sanitized_branch }}
      commit_sha: ${{ steps.vars.outputs.commit_sha }}
      image_tag: ${{ steps.vars.outputs.image_tag }}
      backend_url: ${{ steps.vars.outputs.backend_url }}
      frontend_url: ${{ steps.vars.outputs.frontend_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Predict version bump
        id: version_prediction
        run: |
          git fetch origin main --tags
          MAIN_VERSION=$(git describe --tags --abbrev=0 origin/main 2>/dev/null | sed 's/^v//' || echo "0.0.0")
          
          PR_COMMITS=$(git log origin/main..HEAD --pretty=format:"%s")
          
          BUMP_TYPE="patch"
          if echo "$PR_COMMITS" | grep -iqE "BREAKING CHANGE|MAJOR:|breaking:"; then
            BUMP_TYPE="major"
          elif echo "$PR_COMMITS" | grep -iqE "^feat:|^feature:|MINOR:|minor:|new feature"; then
            BUMP_TYPE="minor"
          fi
          
          IFS='.' read -r major minor patch <<< "$MAIN_VERSION"
          case $BUMP_TYPE in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac
          NEW_VERSION="${major}.${minor}.${patch}"
          
          echo "main_version=$MAIN_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT

      - name: Set up environment
        id: vars
        run: |
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          SANITIZED_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]')
          
          if [ ${#SANITIZED_BRANCH} -gt 30 ]; then
            SANITIZED_BRANCH=$(echo "$SANITIZED_BRANCH" | cut -c1-30)
          fi
          
          SANITIZED_BRANCH=$(echo "$SANITIZED_BRANCH" | sed 's/-*$//')
          
          COMMIT_SHA=$(echo $GITHUB_SHA | cut -c1-7)
          IMAGE_TAG="${SANITIZED_BRANCH}-${COMMIT_SHA}"
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "sanitized_branch=$SANITIZED_BRANCH" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "backend_url=https://api-${SANITIZED_BRANCH}.private.bluerelief.app" >> $GITHUB_OUTPUT
          echo "frontend_url=https://${SANITIZED_BRANCH}.private.bluerelief.app" >> $GITHUB_OUTPUT

  build:
    needs: setup
    runs-on: self-hosted
    strategy:
      matrix:
        service:
          - name: backend
            context: server
            dockerfile: Dockerfile.prod
            image: bluerelief/backend
          - name: frontend
            context: client
            dockerfile: Dockerfile.prod
            image: bluerelief/frontend
          - name: email-service
            context: email-service
            dockerfile: Dockerfile
            image: bluerelief/email-service
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build and push ${{ matrix.service.name }}
        run: |
          cd ${{ matrix.service.context }}
          
          BUILD_ARGS="--build-arg VERSION=${{ needs.setup.outputs.new_version }}"
          
          if [ "${{ matrix.service.name }}" = "backend" ]; then
            BUILD_ARGS="$BUILD_ARGS --build-arg COMMIT_SHA=${{ needs.setup.outputs.commit_sha }}"
          elif [ "${{ matrix.service.name }}" = "frontend" ]; then
            BUILD_ARGS="$BUILD_ARGS --build-arg NEXT_PUBLIC_API_URL=${{ needs.setup.outputs.backend_url }}"
            BUILD_ARGS="$BUILD_ARGS --build-arg NEXT_PUBLIC_MAPBOX_TOKEN=${{ secrets.NEXT_PUBLIC_MAPBOX_TOKEN }}"
            BUILD_ARGS="$BUILD_ARGS --build-arg NEXT_PUBLIC_IS_PREVIEW=true"
          fi
          
          docker build \
            -f ${{ matrix.service.dockerfile }} \
            $BUILD_ARGS \
            -t ${{ env.REGISTRY }}/${{ matrix.service.image }}:${{ needs.setup.outputs.image_tag }} \
            .
          
          docker push ${{ env.REGISTRY }}/${{ matrix.service.image }}:${{ needs.setup.outputs.image_tag }}

  deploy:
    needs: [setup, build]
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Kubernetes
        run: |
          helm upgrade --install bluerelief-${{ needs.setup.outputs.sanitized_branch }} \
            /home/geeth/Development/k8s/helm/celery-app-chart \
            -f /home/geeth/Development/k8s/helm/celery-app-chart/bluerelief-values.yaml \
            -n bluerelief \
            --create-namespace \
            --set app.image.tag=${{ needs.setup.outputs.image_tag }} \
            --set frontend.image.tag=${{ needs.setup.outputs.image_tag }} \
            --set emailService.image.tag=${{ needs.setup.outputs.image_tag }} \
            --set ingress.host="api-${{ needs.setup.outputs.sanitized_branch }}.private.bluerelief.app" \
            --set frontend.ingress.host="${{ needs.setup.outputs.sanitized_branch }}.private.bluerelief.app" \
            --set emailService.ingress.enabled=true \
            --set emailService.ingress.host="email-api-${{ needs.setup.outputs.sanitized_branch }}.private.bluerelief.app" \
            --set frontend.env.NEXT_PUBLIC_API_URL="${{ needs.setup.outputs.backend_url }}" \
            --set frontend.env.NEXT_PUBLIC_IS_PREVIEW="true" \
            --set app.env.IS_PREVIEW="true" \
            --set app.env.PREVIEW_AUTH_BYPASS="true" \
            --set app.env.REDIRECT_URL="https://${{ needs.setup.outputs.sanitized_branch }}.private.bluerelief.app/dashboard" \
            --set app.env.BACKEND_URL="${{ needs.setup.outputs.backend_url }}" \
            --set app.env.FRONTEND_URL="https://${{ needs.setup.outputs.sanitized_branch }}.private.bluerelief.app" \
            --wait

      - name: Comment on PR
        continue-on-error: true
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸš€ Preview Deployment Ready!\n\n` +
                    `**Backend:** ${{ needs.setup.outputs.backend_url }}\n` +
                    `**Frontend:** ${{ needs.setup.outputs.frontend_url }}\n` +
                    `**Email Service:** https://email-api-${{ needs.setup.outputs.sanitized_branch }}.private.bluerelief.app\n\n` +
                    `Commit: \`${{ needs.setup.outputs.commit_sha }}\`\n\n` +
                    `---\n\n` +
                    `## ğŸ” Authentication\n` +
                    `**Demo Login:** Click "Google Sign In" â†’ Use demo auth (no Google account needed)\n` +
                    `Demo Account: \`demo@bluerelief.test\`\n` +
                    `_Note: Google OAuth not available for preview domains. Demo mode enabled for testing._\n\n` +
                    `---\n\n` +
                    `## âœ¨ Version Bump Prediction\n` +
                    `When this PR is merged to main, the version will be bumped:\n\n` +
                    `**${{ needs.setup.outputs.main_version }}** â†’ **${{ needs.setup.outputs.new_version }}** (${{ needs.setup.outputs.bump_type }})\n\n` +
                    `ğŸ’¡ **How to change the version bump type**\n` +
                    `- For **patch**: Use \`fix:\`, \`chore:\`, \`docs:\`, or \`ci:\` in commit messages\n` +
                    `- For **minor**: Use \`feat:\` or \`feature:\` in commit messages\n` +
                    `- For **major**: Include \`BREAKING CHANGE\` or \`breaking:\` in commit messages\n\n` +
                    `_Preview will be automatically deleted when PR is closed or merged._`
            })
      
      - name: Print deployment info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Preview Deployment Ready!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Backend:       ${{ needs.setup.outputs.backend_url }}"
          echo "Frontend:      ${{ needs.setup.outputs.frontend_url }}"
          echo "Email Service: https://email-api-${{ needs.setup.outputs.sanitized_branch }}.private.bluerelief.app"
          echo "Commit:        ${{ needs.setup.outputs.commit_sha }}"
          echo ""
          echo "Version Prediction:"
          echo "  Current:  v${{ needs.setup.outputs.main_version }}"
          echo "  New:      v${{ needs.setup.outputs.new_version }}"
          echo "  Type:     ${{ needs.setup.outputs.bump_type }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  deploy-preview:
    needs: [setup, build, deploy]
    runs-on: self-hosted
    if: always()
    steps:
      - name: Check deployment status
        run: |
          if [ "${{ needs.setup.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.deploy.result }}" != "success" ]; then
            echo "âŒ Deployment failed"
            exit 1
          fi
          echo "âœ… Preview deployment successful"