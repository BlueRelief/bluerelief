name: Lint and Format

on:
  pull_request:
    paths:
      - 'server/**/*.py'
      - 'client/**/*.{ts,tsx,js,jsx,mjs}'
      - 'email-service/**/*.{ts,tsx,js}'
      - '.github/workflows/lint-and-format.yml'
  push:
    branches:
      - main
      - develop
    paths:
      - 'server/**/*.py'
      - 'client/**/*.{ts,tsx,js,jsx,mjs}'
      - 'email-service/**/*.{ts,tsx,js}'

permissions:
  contents: write
  pull-requests: write

jobs:
  # Backend Python formatting and linting
  format-backend:
    name: Format & Lint Backend (Python)
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Format with Black
        uses: psf/black@stable
        with:
          options: "--line-length 88 --preview"
          src: "./server"

  # Frontend formatting and linting
  format-frontend:
    name: Format & Lint Frontend (Next.js)
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'
          cache-dependency-path: 'client/pnpm-lock.yaml'

      - name: Install dependencies
        working-directory: ./client
        run: pnpm install --frozen-lockfile

      - name: Format with Prettier
        uses: creyD/prettier_action@v4.3
        with:
          prettier_options: --write "client/**/*.{ts,tsx,js,jsx,mjs,json,css}"
          commit_message: "style(frontend): auto-format with prettier [skip ci]"
          only_changed: false

  # Email Service formatting and linting
  format-email-service:
    name: Format & Lint Email Service (TypeScript)
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'
          cache-dependency-path: 'email-service/pnpm-lock.yaml'

      - name: Install dependencies
        working-directory: ./email-service
        run: pnpm install --frozen-lockfile

      - name: Format with Prettier
        uses: creyD/prettier_action@v4.3
        with:
          prettier_options: --write "email-service/**/*.{ts,tsx,js}"
          commit_message: "style(email-service): auto-format with prettier [skip ci]"
          only_changed: false

